name: Build and Package

on:
  push:
    branches:
      - main

jobs:
  build-and-package:
    name: Build and Package Plugin
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Extract version from manifest
        id: get_version
        shell: pwsh
        run: |
          $VERSION = jq -r '.Version' assets/manifest.json
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $env:GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          git rev-parse "v${{ steps.get_version.outputs.version }}" 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0) {
            echo "exists=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "exists=false" >> $env:GITHUB_OUTPUT
          }
          exit 0

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Package the Stream Deck plugin
        uses: j4ckofalltrades/streamdeck-package@main
        with:
          input-directory: dist/co.raphii.streamdeck-display-brightness.sdPlugin
          output-directory: release

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.tag }}
          files: release/*.streamDeckPlugin
          generate_release_notes: true
          draft: false
          prerelease: false
